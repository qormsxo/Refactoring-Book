# CAHPTER 2 리팩터링 원칙

## 2.1 리팩터링 정의

---


다른 소프트웨어 개발 용어와 마찬가지로 리팩터링(Refactoring)도 엔지니어들 사이에서 두루뭉실한 의미로 통용된다. 
하지만 책에서는 이 용어를 더 구체적인 의미로 사용하고 정의해야 한다고 기술한다.

### 명사 
> 리팩터링 : [명사] 소프트웨어의 겉보기 동작은 그대로 유지한 채, 코드를 이해하고 수정하기 쉽도록 내부 구조를 변경하는 기법

### 동사 
> 리팩터링(하다): [동사] 소프트웨어의 겉보기 동작을 그대로 유지한 채, 여러가지 리팩터링 기법을 적용해서 소프트웨어를 재구성한다.

많은 사람들이 코드를 정리하는 작업을 '리팩터링' 이라고 표현하고 있는데, 여기서는 '특정한 방식에 따라 코드를 정리하는 것' 이 리팩터링이다.


__누군가 "리팩터링하다가 코드가 깨져서 며칠이나 고생했다" 라고 한다면, 십중팔구 리팩터링한 것이 아니다.__

책에서는 코드베이스를 정리하거나 구조를 바꾸는 모든 작업을 **재구성(Restructuring)** 이라는 용어로 표현하고,

리팩터링은 재구성 중 특수한 한 형태로 본다.

리팩터링은 성능 최적화와 비슷하다.

둘 다 코드를 변경하지만 프로그램의 기능은 정상적으로 작동한다.

단지 목적만 다를 뿐이다.

리팩터링은 코드를 이해하고 수정하기 쉽게 바꾸는 것이라면 성능 최적화는 오로지 속도에만 싱경쓴다.

그래서 목표 성능에 반드시 도달해야 한다면 코드의 이해는 더 어려워질 수 있다.

<hr style="border: 2px solid;">

## 2.1 두 개의 모자

---

이 책의 저자는 소프트웨어를 개발할 때 목적이 '기능추가' 이냐 '리팩터링' 이냐를 명확히 구분하여 작업한다고 한다.

켄트 벡은 이를 두 개의 모자에 비유했다. 

기능을 추가할때는 '기능 추가' 모자를 쓰고 기존 코드는 건드리지 않고 새 기능을 추가하기만한다.

진척도는 테스트를 추가해서 통과하는지 확인하는 방식으로 측정한다.

리팩터링할 때는 '리팩터링' 모자를 쓴 다음 기능 추가는 절대 하지 않기로 마음먹고 오로지 코드 재구성에만 전념한다.

테스트도 만들지 않는다.

부득이 인터페이스를 변경할 때만 기존 테스트를 수정한다. (인터페이스를 바꾸는 건 기능 추가의 종류 중 하나라고 생각한다.)

저자는 소프트웨어를 개발하는 동안 두 모자를 자주 바꿔 쓴다.

새 기능을 추가하다 보면 코드 구조를 바꿔야 작업하기 훨씬 수월하겠다는 생각이 드는데 그러면 잠시 '기능 추가 모자' 에서 '리팩터링 모자' 로 바꿔쓴다.

그 다음에 리팩터링이 다 끝나면 기존의 기능 추가 모자를 다시 쓴다.

<hr style="border: 2px solid;">

## 2.3 리팩터링 하는 이유

---

리팩터링이 소프트웨어의 모든 문제점을 해결하는 만병통치약은 아니지만

코드를 건강한 상태로 유지하는데 도와주는 약임은 분명하다.


### <span style="color: skyblue;">리팩터링하면 소프트웨어 설계가 좋아진다</span>
리팩터링 하지 않으면 소프트웨어의 내부 설계(아키텍처) 가 썩기 쉽다.

아키텍처를 충분히 이해하지 못한 채 단기 목표만을 위해 코드를 수정하다 보면 기반 구조가 무너지기 쉽다.

코드만 봐서는 설계를 파악하기 어려워지고 코드 구조가 무너지기 시작하면 악효과가 누적된다.

코드만으로 설계를 파악하기 어려워질수록 설계를 유지하기 어려워지고, 설계가 부패된다.

같은 일을 하더라도 설계가 나쁘면 코드가 길어진다.

사실상 같은 일을 하는 코드가 여러곳에 나타나게 된다.

중복 코드가 낳는 문제는 수정하는 비용과 이해하는 비용이 크게 증가한다는 점이다.


### <span style="color: skyblue;">리팩터링하면 소프트웨어를 이해하기 쉬워진다.</span>

프로그래밍은 여러 면에서 컴퓨터와 대화하는 것과 같다.

컴퓨터에게 시킬 일을 표현하는 코드를 작성하면 컴퓨터는 정확히 시킨대로 반응한다.

그래서 컴퓨터에게 시킬 일과 이를 표현하는 코드의 차이를 최대한 줄여야 한다.

그러므로 프로그래밍은 내가 원하는 바를 정확히 표현하는 것이다.

그치만 코드는 컴퓨터만 읽는게 아니다.

나와 같이 일하는 또는 개발자도 코드를 읽는다.

코드를 이해하기 쉽게 쓰지 않았더라면 이는 다른 개발자를 배려하지 못한 것이다.

### <span style="color: skyblue;">리팩터링하면 버그를 쉽게 찾을 수 있다.</span>

코드를 이해하기 십다는 말은 버그를 찾기 쉽다는 말과도 같다.

리팩터링 하면 코드가 하는 일이 명확해지므로 이는 버그를 발견하는데 도움을 준다.

리팩터링을 통해 프로그램의 구조를 명확하게 다듬으면 '그냥 이럴 것이다' 라고 가정하던 부분들이 명확히 드러나는데 이를 통해 버그를 쉽게 찾을 수 있다.

이 사실은 켄트 백의 말을 떠올리게 해준다. 

>"난 뛰어난 프로그래머가 아니에요. 단지 뛰어난 습관을 지닌 괜찮은 프로그래머일 뿐이에요."

리팩터링은 견고한 코드를 작성하는 데 무척 효과적이다.


### <span style="color: skyblue;">리팩터링하면 프로그래밍 속도를 높일 수 있다.</span>

지금까지 제시한 장점을 한마디로 정리한다면 다음과 같다.

<span style="color: red;">**리팩터링하면 코드 개발 속도를 높일 수 있다.**</span>

얼핏 그 반대가 아닌가 생각할 수도 있다.

설명이 부족한 것 같으니 덧붙인다.

### 리팩터링하면 <span style="color: green;">추후 개발 시</span> 프로그래밍 속도를 높일 수 있다.

리팩터링이 내부 설계와 코드 퀄리티를 높일 수 있다는 점은 대부분 순응한다.

하지만 리팩터링하는 데 시간이 드니 전체 개발 속도가 떨어질까봐 걱정할 수도 있다.

한 시스템을 오래 개발하는 개발자들과 얘기하다 보면 초기에는 진척이 빨랐지만 현재는 새 기능을 하나 추가하는데 훨씬 오래 걸린다는 말을 많이 한다.

새로운 기능을 추가할수록 기존 코드베이스에 잘 녹여낼 방법을 찾는 데 드는 시간이 늘어난다는 것이다.

게다가 기능을 추가하다보면 버그가 발생하는 일이 잦고, 이를 해결하는 시간은 한층 더 걸린다.

이러한 부담이 점점 늘어나다보면 차라리 처음부터 새로 개발하는 편이 낫겠다고 생각하는 지경에 다다른다.

하지만 좋은 설계를 지닌 팀은 기존에 작성한 코드를 최대한 활요할 수 있어서 새 기능을 더 빨리 추가하는게 가능해진다.

이렇게 차이 나는 원인은 소프트웨어의 내부 품질에 있다.

내부 설계에 심혈을 기울이면 소프트웨어의 지구력이 높아져서 <span style="color: red;">빠르게 개발할 수 있는 상태</span> 를 더 오래 지속할 수 있다.

<hr style="border: 2px solid;">

## 2.4 언제 리팩터링해야 할까?

---

이 책의 저자는 한시간 간격으로 리팩터링 한다고 한다.

그러다 보니 작업 흐름에 리팩터링을 녹이는 방법이 여러 가지임을 알게 됐다.

> ### 3의 법칙
> 이건 돈 로버츠가 제시한 가이드다.
> 1. 처음에는 그냥 (기능 개발을)한다.
> 2. 비슷한 동작을 두번째로 하게 되면(중복) 일단 계속 진행한다.
> 3. 비슷한 동작을 세번째 하게 되면 리팩터링한다.
> 
> 야구를 좋아하는 사람은 "스트라이크 세 번이면 리팩터링하라" 하고 기억해도 좋다.

### 준비를 위한 리팩터링: 기능을 쉽게 추가하게 만들기

리팩터링하기 가장 좋은 시점은 코드베이스에 **기능을 새로 추가하기 직전**이다.

이 시점에서 현재 코드를 살펴보면서, 구조를 살짝 바꾸면 다른 작업을 하기가 훨씬 쉬워질 만한 부분을 찾는다.

가령 내 요구사항을 모두 맍고하지만 리터럴 값 몇 개가 방해되는 함수가 있을 수 있다.

> 굳이 비유하자면, 목적지에 갈때 아무 생각 없이 가지 않고 지도를 보고 가장 빠른 경로를 찾아 출발하는 것과 비슷하다.

### 이해를 위한 리팩터링: 코드를 이해하기 쉽게 만들기

코드를 수정하려면 먼저 코드를 파악해야 한다.

코드를 파악할 때마다 그 코드의 의도가 명확하게 드러나도록 리팩터링 할 여지가 없는지 찾아본다. (조건부 로직도 찾아보고, 함수의 이름이 올바른지도 찾아본다.)

이쯤되면 코드를 이해하게 되고 그것들을 후에 기억하기 쉽게 리팩터링 해주면 된다. (리팩터링 하지 않으면 코드를 또 다시 이해하는데 시간이 오래 걸리기 떄문)

### 쓰레기 줍기 리팩터링

코드를 파악하던 중에 일을 비효율적으로 처리하는 모습을 발견할 때가 많다.

로직이 쓸데없이 복잡하거나 매개변수화한 함수 하나면 될 일을 거의 똑같이 함수 여러 개로 작성해놨을 수 있다.

이떄는 절충이 필요하다.

원래 하려던 작업과 관련 없는 일에 너무 많은 시간을 쓰기는 싫다면

간단히 수정할 수 있는 것은 지금하고 그렇지 못한 것은 **메모**해두고 일을 끝내고 처리한다.

이것이 이해를 위한 리팩터링의 변형된 부분인 쓰레기 줍기 리팩터링이다.

### 계획된 리팩터링과 수시로 하는 리팩터링

앞에서 본 리팩터링은 모두 기회가 될 때만 한다.

개발에 들어가기 전에 리팩토링 일정을 따로 잡아두지 않고 기능을 추가하거나 버그를 잡을 때 리팩토링을 같이 한다. (효율성을 추구하기 떄문에 이렇게 하는듯)

기능을 추가하다 보면 대개 새로운 코드를 작성해 넣게 된다.

하지만 뛰어난 개발자는 새 기능을 추가하기 쉽도록 코드를 '수정' 하는 것이 그 기능을 가장 빠르게 추가하는 길일 수 있음을 안다.

### 오래 걸리는 리팩토링

리팩토링은 대부분 몇 분 안에 끝난다. 길어야 몇 시간 정도다.

하지만 팀 전체가 달려들어도 몇 주는 걸리는 대규모 리팩토링이 있다.

이런 상황에 처하더라도 팀 전체가 리팩토링에 매달리는 것은 회의적이다.

**주어진 문제를 몇 주에 걸쳐 조금씩 해결해가는 편이 효과적일 때가 많다. (리팩토링을 대규모로 하면 안되는 작업들이 생길 수 있기 떄문에.)**

### 코드 리뷰에 리팩토링 활용하기

리팩토링은 코드리뷰의 결과를 더 구체적으로 도출하는데 도움을 준다.

### 관리자에게는 뭐라고 말해야 할까?

여기서 말하는 관리자는 **개발팀의 팀장**이 아니다. 

<span style="color: red;"> 개발에 대해 잘 모르는 관리자 </span> 다

그들에게는 이 리팩터링이 가치 없는 일이라고 보일 수도 있다.

이런 관리자에게 리팩터링을 해야한다고 말해야 되는 상황이라면 

그냥 말하지 말고 기능 개발 일정을 늘리자.

### 리팩터링 하지 말아야 할때

1. 지저분한 코드를 발견했으나 지금 당장은 수정할 필요가 없을 때(내부 동작을 이해해야 할 시점에 리팩토링해야 효과를 제대로 볼 수 있다.)
2. 리팩토링하는 것보다 처음부터 새로 작성하는게 쉽다는 생각이 들때 (리팩토링을 직접해봐야 알 수 있다.)

<hr style="border: 2px solid;">

## 2.5 리팩토링 시 고려할 문제

---

### 코드 소유권

함수 이름을 바꾸고 싶어서 함수를 호출하는 곳을 모두 찾아서 바꿀 수도 있지만 그 코드의 소유자가 다른 팀이라서 이를 바꿀 권한이 없을 수 있다.

또는 바꾸려는 함수가 고객에게 제공해주는 API 라면 쓰는 사람 모두를 알기 어렵다.

코드 소유권이 나눠져있다면 리팩토링 하기 어렵다.

하지만 이름만 바꾸고 싶다면 함수를 호출하는 새 함수를 만들면 된다.



